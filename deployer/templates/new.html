{% extends "base.html" %}

{% block content %}
<script src="https://checkout.stripe.com/checkout.js"></script>
<script>
  const dailyCost = {{daily_cost}}
  const testDailyCost = {{test_cost}}
  const fixedCost = {{fixed_cost}}

  let stripeCost;

  var handler = StripeCheckout.configure({
    key: "{{stripe_key}}",
    locale: 'auto',
    token: function (token) {
      document.tournament.stripe_token.value = token.id
      document.tournament.submit()
    }
  });

  function handleSubmit() {
    const emailField = document.getElementById("email")

    if (!document.tournament.stripe_token.value) {
      handler.open({
        name: 'MIT-Tab',
        description: 'MIT-Tab server',
        email: emailField.value,
        amount: stripeCost
      });
    }

    return !!document.tournament.stripe_token.value;
  }

  // Close Checkout on page navigation:
  window.addEventListener('popstate', function () {
    handler.close();
  });

  document.addEventListener('DOMContentLoaded', function () {
    var checkbox = document.getElementById("add_test")
    var submit = document.getElementById("submit_button")

    checkbox.addEventListener('change', function () {
      document.tournament.stripe_token = null;
      if (this.checked) {
        // submit.value = 'Confirm & Pay both costs'
        // set strpeCost
      } else {
        // submit.value = 'Confirm & Pay regular cost'
        // set stripeCost
      }
    });
  })
</script>

<center>
  <h1>Create a Tournament</h1>
</center>

<br>

<form action="/tournaments/new" method="post" id="form" name="tournament">
  {{ form.hidden_tag() }}

  <div class="form-group">
    {{ form.name.label }}
    <span class="help-block">
      This will be the subdomain for the tournament (e.g.
      example.nu-tab.com). Cannot include spaces or special characters.
    </span>
    {% for error in form.name.errors %}
    <span class="text-danger">[{{error}}]</span>
    {% endfor %}<br>
    {{ form.name(class='form-control') }}
  </div>

  <div class="form-group">
    {{ form.password.label }}
    <span class="help-block">
      You should choose a password you're comfortable sharing with tab staff
      members. Avoid something you use for other web sites.
    </span>
    {% for error in form.password.errors %}
    <span class="text-danger">[{{error}}]</span>
    {% endfor %}<br>
    {{ form.password(class='form-control') }}
  </div>

  <div class="form-group">
    {{ form.email.label }}
    <span class="help-block">
      You will receive an email with info about running the tournament.
    </span>
    {% for error in form.email.errors %}
    <span class="text-danger">[{{error}}]</span>
    {% endfor %}<br>
    {{ form.email(class='form-control', id='email') }}
  </div>

  <div class="form-group">
    {{ form.deletion_date.label }}
    <span class="help-block">
      The tournament will be deleted on this date. The cost of a tournament is
      a $15 fixed fee + $1 per day active.

      It's recommended to select a few days after your tournament ends to give
      yourself time to upload results.
    </span>
    {% for error in form.deletion_date.errors %}
    <span class="text-danger">[{{error}}]</span>
    {% endfor %}<br>
    {{ form.deletion_date(placeholder="mm/dd/yyyy", class="form-control") }}
  </div>

  <div class="form-group">
    {{ form.repo_options.label }}
    {% for error in form.repo_options.errors %}
    <span class="text-danger">[{{error}}]</span>
    {% endfor %}<br>
    {{ form.repo_options(class='form-control') }}
  </div>

  <div class="form-group">
    {{ form.add_test.label }}: {{ form.add_test }}
    <span class="help-block">
      This will spin up a smaller tournament at
      [tournament_name]-test.nu-tab.com pre-loaded with test data. If you've
      never run a tournament with mit-tab, this is a good way to learn the
      software.
      <br />
      <b>This will cost an extra $1/day</b>
    </span>
    {% for error in form.add_test.errors %}
    <span class="text-danger">[{{error}}]</span>
    {% endfor %}<br>
  </div>

  <input type="submit" id="submit_button" value="Confirm" class="btn btn-primary" />
</form>
{% endblock %}
